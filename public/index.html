<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅花义理·数智引擎</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --main-color: #333; --bg-color: #f5f5f7; --accent-color: #b22222; }
        body { font-family: 'PingFang SC', serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; }
        .header { text-align: center; margin-bottom: 20px; }
        
        /* 起卦控制台样式 */
        .casting-panel { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 8px 15px; cursor: pointer; border: none; background: none; color: #666; font-size: 14px; }
        .tab-btn.active { color: var(--accent-color); font-weight: bold; border-bottom: 2px solid var(--accent-color); }
        .method-content { display: none; margin-top: 10px; }
        .method-content.active { display: block; }
        
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-right: 5px; font-size: 14px; }
        .gua-display { display: flex; justify-content: space-around; background: #fffdf8; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px dashed #dcd0ba; display: none; }
        .gua-item { text-align: center; }
        .gua-symbol { font-size: 30px; line-height: 1; margin-bottom: 5px; color: var(--main-color); }
        
        /* 聊天区域 */
        .chat-box { height: 400px; background: #fff; border-radius: 12px; overflow-y: auto; padding: 20px; border: 1px solid #eee; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 16px; border-radius: 8px; max-width: 85%; font-size: 15px; line-height: 1.6; }
        .user-msg { background: var(--main-color); color: #fff; align-self: flex-end; }
        .bot-msg { background: #f9f9fa; border: 1px solid #eee; align-self: flex-start; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; }
        button.primary-btn { background: var(--main-color); color: #fff; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>梅花义理·数智引擎</h1>
            <p>先起卦，后断语。逻辑严密，天机尽显。</p>
        </div>

        <div class="casting-panel">
            <div class="tabs">
                <div class="tab-btn active" onclick="switchTab(0)">时间起卦</div>
                <div class="tab-btn" onclick="switchTab(1)">报数起卦</div>
                <div class="tab-btn" onclick="switchTab(2)">手动选卦</div>
            </div>

            <div id="method0" class="method-content active">
                <span style="font-size:13px; color:#888;">系统将根据当前精准时空参数自动推演</span>
            </div>

            <div id="method1" class="method-content">
                <input type="number" id="num1" placeholder="第一个数">
                <input type="number" id="num2" placeholder="第二个数">
                <input type="number" id="num3" placeholder="动爻基数">
            </div>

            <div id="method2" class="method-content">
                上卦：<select id="manualUpper">
                    <option value="1">乾一</option><option value="2">兑二</option><option value="3">离三</option><option value="4">震四</option>
                    <option value="5">巽五</option><option value="6">坎六</option><option value="7">艮七</option><option value="8">坤八</option>
                </select>
                下卦：<select id="manualLower">
                    <option value="1">乾一</option><option value="2">兑二</option><option value="3">离三</option><option value="4">震四</option>
                    <option value="5">巽五</option><option value="6">坎六</option><option value="7">艮七</option><option value="8">坤八</option>
                </select>
                动爻：<select id="manualMove">
                    <option value="1">初爻</option><option value="2">二爻</option><option value="3">三爻</option>
                    <option value="4">四爻</option><option value="5">五爻</option><option value="6">上爻</option>
                </select>
            </div>

            <div class="gua-display" id="guaResult">
                <div class="gua-item"><div class="gua-symbol" id="symBen"></div><div>本卦</div></div>
                <div class="gua-item"><div class="gua-symbol" id="symHu"></div><div>互卦</div></div>
                <div class="gua-item"><div class="gua-symbol" id="symBian"></div><div>变卦</div></div>
                <div id="dongYaoInfo" style="font-size:12px; color:var(--accent-color); padding-top:10px;"></div>
            </div>
            
            <div style="text-align:right; margin-top:15px;">
                <button class="primary-btn" onclick="generateGua()">生成卦象</button>
            </div>
        </div>

        <div class="chat-box" id="chatBox">
            <div class="message bot-msg">请先在上方完成起卦，然后在下方输入您的困惑，最后点击“请大师断卦”。</div>
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="输入您的问题（如：问事业升迁...）">
            <button class="primary-btn" onclick="sendToAI()">请大师断卦</button>
        </div>
    </div>

    <script>
        const symbols = ["", "☰", "☱", "☲", "☳", "☴", "☵", "☶", "☷"];
        const guaNames = ["", "乾", "兑", "离", "震", "巽", "坎", "艮", "坤"];
        let currentGuaData = null;
        let activeTab = 0;

        function switchTab(i) {
            activeTab = i;
            document.querySelectorAll('.tab-btn, .method-content').forEach((el, idx) => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn')[i].classList.add('active');
            document.getElementById('method' + i).classList.add('active');
        }

        // 核心逻辑：梅花易数算法
        function generateGua() {
            let u, l, m;
            const now = new Date();

            if (activeTab === 0) { // 时间起卦 (简化版，可根据需要引入农历库)
                u = (now.getHours() + now.getDate()) % 8 || 8;
                l = (now.getMinutes() + now.getSeconds()) % 8 || 8;
                m = (u + l) % 6 || 6;
            } else if (activeTab === 1) { // 报数
                u = parseInt(document.getElementById('num1').value) % 8 || 8;
                l = parseInt(document.getElementById('num2').value) % 8 || 8;
                m = parseInt(document.getElementById('num3').value) % 6 || 6;
            } else { // 手动
                u = parseInt(document.getElementById('manualUpper').value);
                l = parseInt(document.getElementById('manualLower').value);
                m = parseInt(document.getElementById('manualMove').value);
            }

            // 计算互卦和变卦逻辑（这里简略，实际可更复杂）
            currentGuaData = {
                upper: guaNames[u], lower: guaNames[l],
                movingLine: m,
                summary: `本卦为【${guaNames[u]}${guaNames[l]}】，第${m}爻动。`
            };

            document.getElementById('symBen').textContent = symbols[u] + symbols[l];
            document.getElementById('symHu').textContent = "☯"; // 互卦计算略
            document.getElementById('symBian').textContent = "❂"; // 变卦计算略
            document.getElementById('dongYaoInfo').textContent = `动爻：第 ${m} 爻`;
            document.getElementById('guaResult').style.display = 'flex';
        }

        async function sendToAI() {
            if (!currentGuaData) return alert("请先生成卦象！");
            const input = document.getElementById('userInput');
            const q = input.value.trim();
            if (!q) return alert("请输入您的问题！");

            const fullPrompt = `【起卦结果】：${currentGuaData.summary}\n【求测问题】：${q}\n\n请作为梅花易数大师，直接针对以上确定的卦象和问题进行解析。`;
            
            appendMessage(q, 'user-msg');
            input.value = '';
            
            // 后续调用 API 逻辑同前...
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: fullPrompt })
            });
            const data = await response.json();
            appendMessage(data.reply, 'bot-msg', true);
        }

        function appendMessage(text, className, isMarkdown = false) {
            const box = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${className}`;
            msgDiv.innerHTML = isMarkdown ? marked.parse(text) : text;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
